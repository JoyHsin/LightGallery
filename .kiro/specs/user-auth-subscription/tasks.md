# 实施计划

## iOS 客户端实现

- [x] 1. 搭建认证模块结构
  - 创建 Models 文件夹，包含 User、AuthToken、AuthProvider 枚举
  - 创建 Services 文件夹，包含 AuthenticationService
  - 创建 ViewModels 文件夹，包含 AuthViewModel
  - 创建 Views 文件夹，包含 LoginView、AuthLoadingView
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. 实现 Apple ID 登录
- [x] 2.1 创建 AppleSignInManager
  - 使用 AuthenticationServices 框架实现 Sign in with Apple
  - 处理 ASAuthorizationControllerDelegate 回调
  - 提取用户凭证（用户 ID、邮箱、姓名）
  - _需求: 1.3_

- [x] 2.2 将 Apple Sign In 集成到 AuthenticationService
  - 从 AuthenticationService 调用 AppleSignInManager
  - 使用 SecureStorage 将认证令牌存储到 Keychain
  - 创建或获取 User 模型
  - _需求: 1.4, 2.1_

- [x] 2.3 编写 Apple Sign In 的属性测试
  - **属性 1: OAuth 提供商路由**
  - **验证需求: 1.1, 1.2, 1.3**

- [x] 3. 实现微信 OAuth 登录
- [x] 3.1 集成微信 SDK
  - 将微信 SDK 添加到项目
  - 在 Info.plist 中配置微信 App ID
  - 实现微信回调的 URL scheme 处理
  - _需求: 1.1_

- [x] 3.2 创建 WeChatOAuthManager
  - 实现微信 OAuth 流程
  - 处理 OAuth 回调并提取授权码
  - 通过后端交换授权码获取访问令牌
  - _需求: 1.1, 1.4_

- [x] 3.3 编写微信 OAuth 的属性测试
  - **属性 1: OAuth 提供商路由**
  - **验证需求: 1.1, 1.2, 1.3**

- [x] 4. 实现支付宝 OAuth 登录
- [x] 4.1 集成支付宝 SDK
  - 将支付宝 SDK 添加到项目
  - 在 Info.plist 中配置支付宝 App ID
  - 实现支付宝回调的 URL scheme 处理
  - _需求: 1.2_

- [x] 4.2 创建 AlipayOAuthManager
  - 实现支付宝 OAuth 流程
  - 处理 OAuth 回调并提取授权码
  - 通过后端交换授权码获取访问令牌
  - _需求: 1.2, 1.4_

- [x] 4.3 编写支付宝 OAuth 的属性测试
  - **属性 1: OAuth 提供商路由**
  - **验证需求: 1.1, 1.2, 1.3**

- [x] 5. 实现安全令牌存储
- [x] 5.1 创建 SecureStorage 类
  - 实现 Keychain 封装用于存储认证令牌
  - 使用 kSecAttrAccessibleAfterFirstUnlock 设置令牌可访问性
  - 实现保存、读取和删除方法
  - _需求: 2.1, 10.1_

- [x] 5.2 编写令牌存储的属性测试
  - **属性 2: 成功认证存储**
  - **属性 34: 安全令牌存储**
  - **验证需求: 1.4, 2.1, 10.1**

- [x] 6. 实现会话管理
- [x] 6.1 创建会话验证逻辑
  - 在应用启动时实现令牌验证
  - 如果令牌有效则自动恢复用户会话
  - 如果令牌无效或过期则清除会话数据
  - _需求: 2.2, 2.3, 2.4_

- [x] 6.2 实现登出功能
  - 从 Keychain 清除所有认证数据
  - 重置 AuthViewModel 中的用户状态
  - 导航到登录界面
  - _需求: 2.5_

- [x] 6.3 编写会话管理的属性测试
  - **属性 4: 会话恢复**
  - **属性 5: 无效令牌清理**
  - **属性 6: 登出数据移除**
  - **验证需求: 2.3, 2.4, 2.5**

- [x] 7. 创建认证 UI
- [x] 7.1 构建 LoginView
  - 设计包含三个 OAuth 提供商按钮的登录界面
  - 添加 Apple Sign In 按钮（原生样式）
  - 添加微信登录按钮（带品牌标识）
  - 添加支付宝登录按钮（带品牌标识）
  - _需求: 1.1, 1.2, 1.3_

- [x] 7.2 实现 AuthViewModel
  - 将 UI 连接到 AuthenticationService
  - 处理认证过程中的加载状态
  - 显示认证失败的错误消息
  - _需求: 1.5_

- [x] 7.3 编写 AuthViewModel 的单元测试
  - 测试加载状态转换
  - 测试错误处理
  - 测试成功认证流程
  - _需求: 1.5_

- [x] 8. 检查点 - 确保认证测试通过
  - 确保所有测试通过，如有问题请询问用户

## 订阅模块 (iOS)

- [x] 9. 搭建订阅模块结构
  - 创建 Subscription、SubscriptionProduct、SubscriptionTier 模型
  - 创建 SubscriptionService、AppleIAPManager 服务
  - 创建 SubscriptionViewModel 视图模型
  - 创建 SubscriptionView、PaywallView 视图
  - _需求: 3.1, 3.2_

- [x] 10. 实现 Apple IAP 集成
- [x] 10.1 使用 StoreKit 2 创建 AppleIAPManager
  - 使用 Product.products(for:) 实现产品获取
  - 使用 Transaction.updates 设置交易监听器
  - 使用 product.purchase() 实现购买流程
  - 使用 VerificationResult 处理交易验证
  - _需求: 4.1, 4.2_

- [x] 10.2 实现收据验证
  - 将交易收据发送到后端进行验证
  - 验证成功后更新订阅状态
  - 处理验证失败情况
  - _需求: 4.2, 4.3_

- [x] 10.3 编写 IAP 的属性测试
  - **属性 10: iOS 支付路由**
  - **属性 11: 收据验证**
  - **属性 12: 支付成功同步**
  - **验证需求: 4.1, 4.2, 4.3**

- [x] 11. 实现订阅状态管理
- [x] 11.1 创建 SubscriptionService
  - 实现 fetchAvailableProducts() 加载 IAP 产品
  - 实现 getCurrentSubscription() 获取用户订阅
  - 实现 validateSubscription() 检查订阅有效性
  - _需求: 3.1, 3.3, 3.4_

- [x] 11.2 实现订阅缓存
  - 创建 SubscriptionCache 类
  - 本地缓存订阅状态，TTL 为 24 小时
  - 实现缓存验证逻辑
  - _需求: 6.3, 9.1, 9.2_

- [x] 11.3 编写订阅管理的属性测试
  - **属性 7: 订阅层级功能**
  - **属性 8: 活跃订阅显示**
  - **属性 19: 缓存优先访问检查**
  - **验证需求: 3.3, 3.4, 6.3**

- [x] 12. 实现订阅 UI
- [x] 12.1 构建 SubscriptionView
  - 显示所有订阅层级（Free、Pro、Max）
  - 显示月付和年付的价格选项
  - 高亮显示当前订阅层级
  - 显示活跃订阅的到期日期
  - _需求: 3.1, 3.2, 3.4_

- [x] 12.2 创建 PaywallView
  - 为高级功能设计付费墙
  - 显示不同层级之间的功能对比
  - 添加 Pro 和 Max 层级的购买按钮
  - _需求: 3.5, 6.1_

- [x] 12.3 编写订阅 UI 的单元测试
  - 测试产品显示逻辑
  - 测试层级高亮显示
  - 测试付费墙触发条件
  - _需求: 3.1, 3.4, 3.5_

- [x] 13. 检查点 - 确保订阅测试通过
  - 确保所有测试通过，如有问题请询问用户

## 访问控制模块 (iOS)

- [x] 14. 实现功能访问控制
- [x] 14.1 创建 FeatureAccessManager
  - 实现 canAccessFeature() 检查权限
  - 定义包含所有高级功能的 PremiumFeature 枚举
  - 将功能映射到所需的订阅层级
  - _需求: 6.1, 6.2, 6.5_

- [x] 14.2 将访问控制集成到现有功能
  - 为 SmartCleanManager 添加访问检查
  - 为所有工具箱功能添加访问检查
  - 当免费用户访问高级功能时显示付费墙
  - _需求: 6.1, 6.5_

- [x] 14.3 编写访问控制的属性测试
  - **属性 17: 免费层级访问限制**
  - **属性 18: 付费层级访问授予**
  - **属性 21: 功能锁定显示**
  - **验证需求: 6.1, 6.2, 6.5**

- [x] 15. 实现订阅过期处理
- [x] 15.1 创建过期检查逻辑
  - 在应用启动时检查订阅过期
  - 订阅过期时限制高级功能
  - 向过期用户显示续订提示
  - _需求: 6.4_

- [x] 15.2 编写过期的属性测试
  - **属性 20: 过期订阅限制**
  - **验证需求: 6.4**

- [x] 16. 实现离线支持
- [x] 16.1 创建离线订阅验证
  - 网络不可用时使用缓存的订阅
  - 如果缓存过期（>24小时）则限制访问
  - 网络恢复时同步订阅
  - _需求: 9.1, 9.2, 9.3_

- [x] 16.2 编写离线支持的属性测试
  - **属性 29: 离线缓存使用**
  - **属性 30: 过期缓存限制**
  - **属性 31: 网络恢复同步**
  - **验证需求: 9.1, 9.2, 9.3**

- [x] 17. 检查点 - 确保访问控制测试通过
  - 确保所有测试通过，如有问题请询问用户

## 后端服务实现 (Java + Spring Boot)

- [x] 18. 搭建 Spring Boot 项目结构
  - 使用 Maven 初始化 Spring Boot 3.x 项目
  - 配置 MySQL 数据库连接
  - 设置 MyBatis-Plus 依赖
  - 创建包结构（controller、service、mapper、entity、dto、config）
  - _需求: 8.1_

- [x] 19. 实现数据库架构
- [x] 19.1 创建 MySQL 数据库和表
  - 创建带索引的 users 表
  - 创建带外键的 subscriptions 表
  - 创建用于审计日志的 transactions 表
  - 创建 auth_tokens 表
  - _需求: 8.5, 10.4_

- [x] 19.2 创建 MyBatis-Plus 实体
  - 使用 @TableName 注解实现 User 实体
  - 实现 Subscription 实体
  - 实现 Transaction 实体
  - 实现 AuthToken 实体
  - _需求: 8.5_

- [x] 19.3 创建 MyBatis-Plus 映射器
  - 创建带自定义查询的 UserMapper
  - 创建带自定义查询的 SubscriptionMapper
  - 创建 TransactionMapper
  - 创建 AuthTokenMapper
  - _需求: 8.1_

- [x] 20. 实现认证端点
- [x] 20.1 创建 AuthController
  - 实现 POST /api/v1/auth/oauth/exchange 端点
  - 实现 POST /api/v1/auth/token/refresh 端点
  - 实现 POST /api/v1/auth/logout 端点
  - 实现 DELETE /api/v1/auth/account 端点
  - _需求: 1.4, 2.5, 10.4_

- [x] 20.2 创建 AuthService
  - 实现 OAuth 令牌交换逻辑
  - 实现 JWT 令牌生成
  - 实现令牌刷新逻辑
  - 实现用户账户删除
  - _需求: 1.4, 2.4, 10.4_

- [x] 20.3 集成 OAuth 提供商
  - 实现微信 OAuth 令牌验证
  - 实现支付宝 OAuth 令牌验证
  - 实现 Apple ID 令牌验证
  - _需求: 1.1, 1.2, 1.3_

- [x] 20.4 编写认证的单元测试
  - 测试 OAuth 令牌交换
  - 测试 JWT 生成和验证
  - 测试令牌刷新逻辑
  - _需求: 1.4, 2.4_

- [x] 21. 实现订阅端点
- [x] 21.1 创建 SubscriptionController
  - 实现 GET /api/v1/subscription/products 端点
  - 实现 GET /api/v1/subscription/status 端点
  - 实现 POST /api/v1/subscription/verify 端点
  - 实现 POST /api/v1/subscription/sync 端点
  - _需求: 3.1, 3.4, 4.3, 7.5_

- [x] 21.2 创建 SubscriptionService
  - 实现订阅产品检索
  - 实现订阅状态检查
  - 实现订阅创建和更新
  - 实现订阅同步逻辑
  - _需求: 3.1, 3.4, 7.5_

- [x] 21.3 编写订阅服务的单元测试
  - 测试产品检索
  - 测试订阅状态逻辑
  - 测试订阅更新
  - _需求: 3.1, 3.4_

- [x] 22. 实现支付验证
- [x] 22.1 创建 PaymentService
  - 实现 Apple IAP 收据验证
  - 实现微信支付验证
  - 实现支付宝支付验证
  - _需求: 4.2, 5.4, 8.1, 8.2, 8.3_

- [x] 22.2 将支付验证集成到订阅更新
  - 更新订阅前验证支付
  - 创建交易审计日志条目
  - 处理验证失败
  - _需求: 4.3, 8.4, 8.5_

- [x] 22.3 编写支付验证的属性测试
  - **属性 26: 支付验证路由**
  - **属性 27: 失败验证拒绝**
  - **属性 28: 审计日志记录**
  - **验证需求: 8.1, 8.2, 8.3, 8.4, 8.5**

- [x] 23. 实现 Spring Security 配置
- [x] 23.1 配置 JWT 认证
  - 创建 JwtAuthenticationFilter
  - 实现 JWT 令牌验证
  - 配置安全过滤器链
  - _需求: 2.2, 2.3, 2.4_

- [x] 23.2 配置 CORS 和 HTTPS
  - 为移动客户端设置 CORS 配置
  - 对所有端点强制使用 HTTPS
  - 配置 TLS 1.2+ 要求
  - _需求: 10.2_

- [x] 23.3 编写安全的属性测试
  - **属性 35: HTTPS 通信**
  - **验证需求: 10.2**

- [x] 24. 实现错误处理和日志记录
- [x] 24.1 创建全局异常处理器
  - 处理认证错误
  - 处理订阅错误
  - 处理支付验证错误
  - 返回适当的 HTTP 状态码
  - _需求: 1.5, 4.4, 8.4_

- [x] 24.2 实现审计日志
  - 记录所有订阅更新
  - 记录所有支付验证
  - 从日志中清理敏感数据
  - _需求: 8.5, 10.5_

- [x] 24.3 编写日志清理的属性测试
  - **属性 38: 日志清理**
  - **验证需求: 10.5**

- [x] 25. 检查点 - 确保后端测试通过
  - 确保所有测试通过，如有问题请询问用户

## 集成和测试

- [x] 26. 将 iOS 客户端与后端集成
- [x] 26.1 配置后端 API 基础 URL
  - 设置特定环境的配置
  - 在 iOS 中实现 BackendAPIClient
  - 添加网络请求/响应日志
  - _需求: 1.4, 3.1, 4.3_

- [x] 26.2 测试端到端认证流程
  - 测试 Apple Sign In → 后端令牌交换 → 会话创建
  - 测试微信 OAuth → 后端令牌交换 → 会话创建
  - 测试支付宝 OAuth → 后端令牌交换 → 会话创建
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 26.3 测试端到端订阅流程
  - 测试 IAP 购买 → 收据验证 → 订阅激活
  - 测试 iOS 和后端之间的订阅状态同步
  - 测试订阅过期处理
  - _需求: 4.1, 4.2, 4.3, 6.4_

- [x] 26.4 编写集成测试
  - 测试完整的认证流程
  - 测试完整的购买流程
  - 测试离线到在线同步
  - _需求: 1.4, 4.3, 9.3_

- [x] 27. 实现订阅管理功能
- [x] 27.1 添加订阅升级功能
  - 计算升级的按比例定价
  - 在 iOS 中实现升级流程
  - 在后端处理升级
  - _需求: 7.2_

- [x] 27.2 添加订阅取消
  - 引导用户到 App Store 进行取消
  - 处理已取消的订阅状态
  - 保持访问直到到期
  - _需求: 7.3, 7.4_

- [x] 27.3 编写订阅管理的属性测试
  - **属性 22: 按比例升级计算**
  - **属性 23: 平台特定取消**
  - **属性 24: 已取消订阅访问**
  - **验证需求: 7.2, 7.3, 7.4**

- [x] 28. 最终检查点 - 确有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行所有集成测试保所
  - 确保所有测试通过，如有问题请询问用户

## 部署和文档

- [x] 29. 准备部署
  - 配置生产数据库
  - 为密钥设置环境变量
  - 配置 Apple IAP 生产环境
  - 在沙盒环境中测试 IAP
  - _需求: 4.1, 4.2_

- [x] 30. 创建 API 文档
  - 生成 Swagger/OpenAPI 文档
  - 记录所有认证端点
  - 记录所有订阅端点
  - 记录错误响应
  - _需求: 8.1_

- [x] 31. 编写部署指南
  - 记录后端部署步骤
  - 记录 iOS 应用配置
  - 记录环境变量
  - 记录数据库迁移步骤
  - _需求: 8.1_
