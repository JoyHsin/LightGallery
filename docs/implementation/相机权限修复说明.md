# 相机权限修复说明

## 问题描述

应用在点击"拍摄自拍"按钮时崩溃，错误信息：
```
This app has crashed because it attempted to access privacy-sensitive data without a usage description. 
The app's Info.plist must contain an NSCameraUsageDescription key.
```

## 修复内容

### 1. 添加相机权限描述

在 `Declutter.xcodeproj/project.pbxproj` 中添加了相机使用说明：

```
INFOPLIST_KEY_NSCameraUsageDescription = "此应用需要访问相机来拍摄证件照。";
```

这个权限描述已添加到：
- Debug 配置
- Release 配置

### 2. 改进相机权限处理

修改了 `Declutter/Views/IDPhotoEditorView.swift` 中的 `CameraPicker`：

**修改前：**
- 直接创建 `UIImagePickerController`
- 没有检查相机可用性
- 返回类型为 `UIImagePickerController`

**修改后：**
- 先检查相机是否可用 (`UIImagePickerController.isSourceTypeAvailable(.camera)`)
- 如果相机不可用，显示友好的错误提示
- 返回类型改为 `UIViewController` 以支持错误处理

## 工作流程

现在当用户点击"拍摄自拍"按钮时：

1. **首次使用**：
   - iOS 会自动弹出权限请求对话框
   - 显示我们设置的权限描述："此应用需要访问相机来拍摄证件照。"
   - 用户可以选择"允许"或"不允许"

2. **权限被授予**：
   - 相机界面打开
   - 显示人脸引导框
   - 用户可以拍摄证件照

3. **权限被拒绝**：
   - 应用不会崩溃
   - 可以引导用户到设置中开启权限

## 测试建议

1. **首次安装测试**：
   - 删除应用
   - 重新安装
   - 点击"拍摄自拍"
   - 验证权限请求对话框是否正确显示

2. **权限拒绝测试**：
   - 在权限对话框中选择"不允许"
   - 验证应用是否正常处理（不崩溃）

3. **权限授予测试**：
   - 在权限对话框中选择"允许"
   - 验证相机是否正常打开
   - 验证人脸引导框是否显示

## 相关文件

- `Declutter.xcodeproj/project.pbxproj` - 项目配置文件（添加了相机权限描述）
- `Declutter/Views/IDPhotoEditorView.swift` - 证件照编辑器视图（改进了相机权限处理）

## 注意事项

- 相机权限是敏感权限，必须在 Info.plist 中声明使用目的
- iOS 会在首次访问相机时自动请求权限
- 用户可以随时在系统设置中修改权限
- 应用应该优雅地处理权限被拒绝的情况
