# Apple IAP 测试指南

## 概述

本指南详细说明如何测试LightGallery应用的Apple内购功能，包括本地后端和手机测试的完整流程。

---

## 🔧 环境配置

### 1. 后端配置

#### 启动本地后端
```bash
cd backend
./mvnw spring-boot:run
```

#### 验证后端运行
```bash
curl http://localhost:8080/api/v1/health
# 应该返回: {"status":"UP"}
```

### 2. 网络配置

#### 获取电脑IP地址
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | head -1
# 输出类似: 192.168.1.56
```

#### 更新iOS应用配置
已更新 `BackendAPIClient.swift` 使用你的局域网IP: `http://192.168.1.56:8080`

#### 确保防火墙允许连接
```bash
# macOS 防火墙设置
sudo pfctl -f /etc/pf.conf
# 或在系统偏好设置 → 安全性与隐私 → 防火墙中允许Java应用
```

### 3. 手机网络配置

- 确保手机和电脑连接同一WiFi网络
- 测试连接：在手机Safari中访问 `http://192.168.1.56:8080/api/v1/health`
- 应该看到 `{"status":"UP"}` 响应

---

## 📱 Apple IAP 测试流程

### 第一步：沙盒账号准备

1. **创建沙盒测试账号**
   - 登录 [App Store Connect](https://appstoreconnect.apple.com)
   - 用户和访问 → 沙盒测试员 → 添加测试员
   - 创建测试Apple ID（使用未注册过的邮箱）

2. **手机设置**
   - 设置 → App Store → 退出当前Apple ID
   - 不要在设置中登录沙盒账号（会在购买时提示）

### 第二步：应用配置

1. **构建并安装到手机**
   ```bash
   # 在Xcode中选择你的iPhone设备
   # Product → Run (⌘+R)
   ```

2. **验证网络连接**
   - 打开应用
   - 查看Xcode控制台日志
   - 应该看到成功的API请求日志

### 第三步：测试购买流程

#### 测试场景1：产品加载
1. 打开应用 → 工具页面
2. 点击任意工具（如"Privacy Wiper"）
3. **预期结果**：
   - 显示付费墙界面
   - 显示4个订阅选项
   - 价格正确显示（¥10/月，¥100/年等）

#### 测试场景2：购买流程
1. 选择"Pro Monthly"订阅
2. 点击"订阅"按钮
3. **预期结果**：
   - 弹出Apple支付界面
   - 提示使用沙盒账号登录
   - 输入沙盒测试账号
   - 确认购买（沙盒环境不会实际扣费）

#### 测试场景3：购买成功
1. 完成购买流程
2. **预期结果**：
   - 显示购买成功消息
   - 自动返回工具页面
   - 工具图标不再显示锁定状态
   - 可以正常使用工具功能

#### 测试场景4：订阅状态
1. 进入设置页面
2. 点击个人信息
3. **预期结果**：
   - 显示"专业版用户"
   - 显示订阅到期时间
   - 显示"管理订阅"选项

---

## 🔍 调试和问题排查

### 常见问题

#### 1. 网络连接失败
**症状**：应用显示网络错误
**解决方案**：
```bash
# 检查后端是否运行
curl http://192.168.1.56:8080/api/v1/health

# 检查防火墙设置
sudo lsof -i :8080

# 重启后端
cd backend && ./mvnw spring-boot:run
```

#### 2. 沙盒购买失败
**症状**：购买时显示"无法连接到App Store"
**解决方案**：
- 确保已退出生产环境Apple ID
- 使用全新的沙盒测试账号
- 检查网络连接稳定性

#### 3. 收据验证失败
**症状**：购买成功但功能未解锁
**解决方案**：
```bash
# 检查后端日志
tail -f backend/logs/application.log

# 查看收据验证请求
curl -X POST http://192.168.1.56:8080/api/v1/subscription/verify \
  -H "Content-Type: application/json" \
  -d '{"transactionId":"test","productId":"com.lightgallery.pro.monthly"}'
```

### 日志调试

#### iOS应用日志
在Xcode控制台查看：
```
🌐 [BackendAPI] Request: POST http://192.168.1.56:8080/api/v1/subscription/verify
✅ [BackendAPI] Response: 200
📥 [BackendAPI] Data: {"success":true,"subscription":{...}}
```

#### 后端日志
```bash
# 实时查看后端日志
tail -f backend/logs/application.log

# 查看特定的订阅相关日志
grep "subscription" backend/logs/application.log
```

---

## 📋 测试检查清单

### 基础功能测试
- [ ] 应用启动正常
- [ ] 网络连接成功
- [ ] 产品列表加载
- [ ] 价格显示正确

### 购买流程测试
- [ ] 点击工具显示付费墙
- [ ] 选择订阅套餐
- [ ] Apple支付界面弹出
- [ ] 沙盒账号登录
- [ ] 购买流程完成

### 功能解锁测试
- [ ] 购买后工具解锁
- [ ] 订阅状态更新
- [ ] 个人信息显示正确
- [ ] 可以正常使用付费功能

### 订阅管理测试
- [ ] 查看订阅详情
- [ ] 升级/降级订阅
- [ ] 取消订阅
- [ ] 恢复购买

---

## 🚀 高级测试场景

### 测试订阅升级
1. 先购买Pro Monthly
2. 再购买Max Monthly
3. 验证升级流程和价格计算

### 测试订阅恢复
1. 删除应用
2. 重新安装
3. 点击"恢复购买"
4. 验证订阅状态恢复

### 测试离线模式
1. 购买订阅
2. 关闭WiFi
3. 重启应用
4. 验证缓存的订阅状态

---

## 📊 性能监控

### 关键指标
- 产品加载时间 < 3秒
- 购买流程完成时间 < 30秒
- 收据验证时间 < 5秒
- 功能解锁响应时间 < 1秒

### 监控命令
```bash
# 监控后端性能
curl -w "@curl-format.txt" -o /dev/null -s http://192.168.1.56:8080/api/v1/subscription/products

# 监控内存使用
top -pid $(pgrep -f "spring-boot")
```

---

## 🔒 安全注意事项

1. **沙盒环境**：确保使用沙盒测试账号，避免实际扣费
2. **网络安全**：本地测试使用HTTP，生产环境必须使用HTTPS
3. **数据保护**：测试数据不要包含真实用户信息
4. **收据验证**：确保所有购买都经过后端验证

---

## 📝 测试报告模板

### 测试环境
- iOS版本：_______
- 设备型号：_______
- 应用版本：_______
- 后端版本：_______
- 网络环境：_______

### 测试结果
- 基础功能：✅/❌
- 购买流程：✅/❌
- 功能解锁：✅/❌
- 订阅管理：✅/❌

### 发现问题
1. _______
2. _______
3. _______

### 建议改进
1. _______
2. _______
3. _______

---

## 🎯 下一步计划

### 短期目标
1. 完成基础IAP功能测试
2. 修复发现的问题
3. 优化用户体验

### 中期目标
1. 部署到云服务器
2. 配置HTTPS
3. 添加更多支付方式

### 长期目标
1. 上架App Store
2. 监控和分析
3. 持续优化

---

**测试完成后，记得将BackendAPIClient配置改回production环境！**